/*! jquery.ms-order-calc
 * Version: 2018.1.0
 * Author: Serhii Ilchenko
 * Description: Calculation of quantity and price of goods
 */
!function(e){function t(t,o){var n=this;n.config=e.extend(!0,{},r,o),n.element=t,n.callbacks(),n.calcAll(),n.changeNumber(),n.removeTimeout=0,n.config.warningRemove?(n.showWarningRemoveItem(),n.cancelRemoveItem()):n.immediateRemoveItem(),n.init()}var r={spinner:".order-calc__number-js",price:".order-calc__price-js",priceSum:".order-calc__price-sum-js",btnRemove:".order-calc__remove-js",row:"tr",totalResult:".order-calc__total-results-js",totalCount:".order-calc__counts-total-js",totalPrice:".order-calc__price-total-js",warningRemove:!1,warningRemoveDelay:3e3,objParams:{},tplRemoveItem:'<div><div><span>Товар удален</span> <a class="order-calc__cancel-js">Отмена</a></div></div>',classes:{init:"ms-order-calc--initialized",hasNotItems:"order-calc__hasnt-items"}};t.prototype.callbacks=function(){var t=this;e.each(t.config,function(e,r){"function"==typeof r&&t.element.on(e+".msOrderCalc",function(e,o){return r(e,t.element,o)})})},t.prototype.calcAll=function(){var t=this,r=0,o=t.element.find(t.config.spinner);e.each(o,function(){var o=e(this),n=+o.val();n&&(r++,t.createObjParams(o,n))}),t.calcTotalResult()},t.prototype.changeNumber=function(){var t=this;t.element.on("change spin",t.config.spinner,function(r,o){var n=e(this),c=o?o.value:+n.val();t.createObjParams(n,c),t.calcTotalResult()})},t.prototype.immediateRemoveItem=function(){var t=this;t.element.on("click",t.config.btnRemove,function(r){var o=e(this).closest(t.config.row),n=o.find(t.config.spinner).data("id");delete t.config.objParams[n],t.calcTotalResult(),t.removeItem(o),r.preventDefault()})},t.prototype.showWarningRemoveItem=function(){var t=this;t.element.on("click",t.config.btnRemove,function(r){var o=e(this).closest(t.config.row),n=o.children(),c=o.find(t.config.spinner).data("id");t.removeItem(t.element.find(".order-calc__remove-row-js")),o.addClass("order-calc__remove-row-js"),n.addClass("order-calc__remove-cell-js"),o.append(e(t.config.tplRemoveItem).clone().addClass("order-calc__remove-warning-js")),delete t.config.objParams[c],t.calcTotalResult(),t.element.trigger("showedWarningRemoveItem.msOrderCalc"),clearTimeout(t.removeTimeout),t.removeTimeout=setTimeout(function(){t.removeItem(o)},t.config.warningRemoveDelay),r.preventDefault()})},t.prototype.cancelRemoveItem=function(){var t=this;t.element.on("click",".order-calc__cancel-js",function(r){clearInterval(t.removeTimeout);var o=e(this).closest(t.config.row),n=o.children();o.removeClass("order-calc__remove-row-js"),n.removeClass("order-calc__remove-cell-js"),o.find(".order-calc__remove-warning-js").remove(),t.element.trigger("canceledRemoveItem.msOrderCalc"),t.calcAll(),r.preventDefault()})},t.prototype.removeItem=function(e){var t=this,r=e.find(t.config.spinner).data("id"),o=e.closest(t.element);e.remove(),delete t.config.objParams[r],t.calcAll(),t.element.trigger("removedItem.msOrderCalc"),o.find(t.config.price).length||(t.element.trigger("removedAllItems.msOrderCalc"),o.addClass(t.config.classes.hasNotItems))},t.prototype.createObjParams=function(t,r){var o=this,n=e(t).closest(o.config.row),c=n.find(o.config.price),a=c.data("price"),i=Math.round(a*r*100)/100,l=t.data("id");o.config.objParams[l]={count:r,price:a,priceSum:i},o.element.trigger("createdObjParams.msOrderCalc",o.config.objParams),c.attr("data-count-sum",r),c.attr("data-price-sum",i),n.find(o.config.priceSum).html(i)},t.prototype.calcTotalResult=function(){var e=this,t=e.sumParam(e.config.objParams,"count"),r=e.sumParam(e.config.objParams,"priceSum");e.element.trigger("getTotalResults.msOrderCalc",{totalCount:t,totalPrice:r}),e.element.find(e.config.totalCount).text(t),e.element.find(e.config.totalPrice).text(r)},t.prototype.sumParam=function(e,t){var r,o=0;for(r in e)o+=e[r][t];return Math.round(100*o)/100},t.prototype.init=function(){this.element.addClass(this.config.classes.init),this.element.trigger("created.msOrderCalc")},e.fn.msOrderCalc=function(r){"use strict";return this.each(function(){new t(e(this),r)})}}(jQuery);